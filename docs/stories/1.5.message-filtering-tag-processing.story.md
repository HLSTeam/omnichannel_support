# Story 1.5: Message Filtering & Tag Processing

## Story Information
- **Epic:** Epic 1 - AI Core & Coordinator Bot
- **Story ID:** 1.5
- **Status:** To Do
- **Story Points:** 5
- **Priority:** High
- **Assignee:** TBD
- **Created:** 2025-08-21
- **Updated:** 2025-08-21

## User Story
**As a** system administrator  
**I want** bot chỉ xử lý message được tag (@bot hoặc /command)  
**So that** bot không spam và chỉ xử lý yêu cầu thực sự

## Acceptance Criteria

### A. Tag Detection
- [ ] Bot detects @bot mentions in any message format
- [ ] Bot detects /command format with parameters
- [ ] Bot ignores messages without tags completely
- [ ] Tag detection is case-insensitive (@BOT, /COMMAND)

### B. Command Parsing
- [ ] Parse @bot "create ticket for issue X" → command: "create_ticket", params: "issue X"
- [ ] Parse /status ABC123 → command: "status", params: "ABC123"
- [ ] Parse /check logs system → command: "check", params: "logs system"
- [ ] Handle malformed commands gracefully

### C. Message Filtering
- [ ] Skip processing for regular chat messages
- [ ] Skip processing for non-tagged messages
- [ ] Log filtered messages for audit purposes
- [ ] Maintain chat flow without bot interference

### D. Error Handling
- [ ] Clear error message for invalid command format
- [ ] Suggestion for correct command usage
- [ ] Graceful handling of empty or malformed tags

## Technical Requirements

### Implementation Details
- **Message Filtering:** Implement regex patterns for tag detection
- **Command Parsing:** Parse both @bot and /command formats
- **Workflow Integration:** Add as first processing step in n8n workflow
- **Logging:** Log all filtered messages for audit trail

### Tag Formats Supported
1. **@bot format:** `@bot <command> <parameters>`
   - Example: `@bot create ticket for system issue`
   - Parsed as: command="create_ticket", params="for system issue"

2. **/command format:** `/<command> <parameters>`
   - Example: `/status ABC123`
   - Parsed as: command="status", params="ABC123"

### Error Scenarios
- **No tag found:** Skip processing, no action
- **Malformed tag:** Clear error message with usage examples
- **Empty command:** Suggest available commands
- **Invalid format:** Provide format guidance

## Dependencies
- **Story 1.1:** Ollama service setup (for intent analysis)
- **Story 1.2:** Intent analysis implementation (for command processing)
- **n8n workflow:** Existing coordinator bot workflow

## Definition of Done
- [ ] Message filtering logic implemented in n8n workflow
- [ ] Tag detection works for both @bot and /command formats
- [ ] Command parsing extracts command and parameters correctly
- [ ] Non-tagged messages are properly filtered and logged
- [ ] Error handling provides clear user guidance
- [ ] Integration testing with existing workflow passes
- [ ] Documentation updated with new functionality

## Dev Notes
- Implement in n8n workflow as first processing step
- Use regex patterns for tag detection
- Maintain message context for proper filtering
- Consider performance impact of regex processing
- Ensure backward compatibility with existing workflows

## Testing Scenarios

### Positive Test Cases
1. **@bot command:** Send "@bot check status" → Bot processes command
2. **/command format:** Send "/status ABC123" → Bot processes command
3. **Case insensitive:** Send "@BOT help" → Bot processes command
4. **With parameters:** Send "@bot create ticket urgent issue" → Bot processes with params

### Negative Test Cases
1. **No tag:** Send "Hello everyone" → Bot ignores message
2. **Malformed tag:** Send "@bot" → Bot shows error message
3. **Invalid command:** Send "/invalid" → Bot shows available commands
4. **Empty message:** Send "@bot " → Bot shows usage guidance

## Performance Considerations
- **Response time:** Tag detection should add <100ms to processing
- **Memory usage:** Regex patterns should be optimized
- **Scalability:** Filtering should handle high message volumes
- **Caching:** Consider caching parsed commands for repeated patterns
