# Story 1.8: Supplier Response Management

## Story Information
- **Epic:** Epic 1 - AI Core & Coordinator Bot
- **Story ID:** 1.8
- **Status:** To Do
- **Story Points:** 5
- **Priority:** Medium
- **Assignee:** TBD
- **Created:** 2025-08-21
- **Updated:** 2025-08-21

## User Story
**As a** system administrator  
**I want** bot xử lý phản hồi từ supplier  
**So that** cập nhật thông tin và thông báo cho admin

## Acceptance Criteria

### A. Supplier Response Detection
- [ ] Automatically detect responses from suppliers
- [ ] Identify supplier based on chat group membership
- [ ] Parse supplier response content
- [ ] Handle multiple response formats

### B. Admin Notification
- [ ] Send immediate notification to admin when supplier responds
- [ ] Include supplier response content in notification
- [ ] Include context (original request, supplier info)
- [ ] Support multiple notification channels (Telegram, email)

### C. Logging & Tracking
- [ ] Log all supplier interactions
- [ ] Track response time from request to supplier response
- [ ] Store supplier response history
- [ ] Generate reports for supplier performance

### D. Response Processing
- [ ] Update request status based on supplier response
- [ ] Handle positive/negative supplier responses
- [ ] Escalate if supplier doesn't respond within timeframe
- [ ] Archive completed supplier interactions

## Technical Requirements

### Implementation Details
- **Response Detection:** Implement in n8n workflow with Telegram integration
- **Admin Notification:** Use workflow context to track supplier interactions
- **Logging System:** Implement admin notification system
- **Status Tracking:** Track supplier response status

### Supplier Response Detection
1. **Message Analysis:** Analyze incoming messages for supplier responses
2. **Group Identification:** Identify supplier groups based on chat title
3. **Context Matching:** Match responses to original requests
4. **Response Validation:** Validate response format and content

### Admin Notification System
1. **Immediate Notification:** Send notification as soon as supplier responds
2. **Content Inclusion:** Include full supplier response in notification
3. **Context Information:** Provide original request context
4. **Multi-channel Support:** Support Telegram and email notifications

### Response Processing Logic
1. **Status Update:** Update request status based on supplier response
2. **Response Classification:** Classify as positive, negative, or neutral
3. **Escalation Handling:** Escalate if no response within timeframe
4. **Archive Management:** Archive completed interactions

## Dependencies
- **Story 1.5:** Message filtering and tag processing
- **Story 1.6:** Role-based access control
- **Story 1.7:** Transaction status API integration
- **n8n workflow:** Existing coordinator bot workflow
- **Admin notification system:** For sending admin alerts

## Definition of Done
- [ ] Supplier response detection implemented in n8n workflow
- [ ] Admin notification system working for supplier responses
- [ ] Logging and tracking system captures all interactions
- [ ] Response processing handles all response types
- [ ] Escalation system works for delayed responses
- [ ] Integration testing with existing workflow passes
- [ ] Admin notification testing validates all scenarios
- [ ] Documentation updated with supplier management details

## Dev Notes
- Implement in n8n workflow with Telegram integration
- Use workflow context to track supplier interactions
- Implement admin notification system
- Consider response timeout and escalation logic

## Supplier Management Workflow

### Response Detection Flow
1. **Message Received:** Bot receives message in supplier group
2. **Group Analysis:** Check if message is from supplier group
3. **Context Matching:** Match to existing supplier requests
4. **Response Validation:** Validate response format and content

### Admin Notification Flow
1. **Response Detected:** Supplier response identified
2. **Context Gathering:** Gather original request context
3. **Notification Creation:** Create admin notification
4. **Multi-channel Delivery:** Send via Telegram and email

### Response Processing Flow
1. **Response Analysis:** Analyze supplier response content
2. **Status Update:** Update request status accordingly
3. **Escalation Check:** Check if escalation is needed
4. **Archive Decision:** Decide if interaction is complete

## Notification System

### Admin Notification Content
- **Supplier Information:** Name, group, contact details
- **Original Request:** What was requested from supplier
- **Supplier Response:** Full response content
- **Response Time:** How long supplier took to respond
- **Next Actions:** Recommended next steps

### Notification Channels
1. **Telegram Notification:** Immediate notification to admin
2. **Email Notification:** Detailed notification with full context
3. **System Log:** Log all notifications for audit trail
4. **Dashboard Update:** Update admin dashboard if available

## Logging & Tracking

### Interaction Logging
- **Request Details:** Original request to supplier
- **Supplier Info:** Supplier identification and group
- **Response Content:** Full supplier response
- **Timing Data:** Request and response timestamps
- **Status Changes:** Request status updates

### Performance Tracking
- **Response Time:** Time from request to supplier response
- **Response Quality:** Classification of response quality
- **Supplier Reliability:** Track supplier response patterns
- **Escalation Frequency:** How often escalation is needed

## Escalation System

### Escalation Triggers
1. **No Response:** Supplier doesn't respond within timeframe
2. **Incomplete Response:** Response doesn't address request fully
3. **Negative Response:** Supplier declines or cannot fulfill request
4. **Quality Issues:** Response quality below acceptable standards

### Escalation Actions
1. **Admin Alert:** Immediate notification to admin
2. **Alternative Supplier:** Contact alternative suppliers if available
3. **Manual Intervention:** Admin takes over the request
4. **Request Modification:** Modify request based on supplier feedback

## Testing Scenarios

### Response Detection Tests
1. **Valid Response:** Supplier responds to request → Detected correctly
2. **Invalid Response:** Non-supplier message → Not detected
3. **Multiple Responses:** Multiple suppliers respond → All detected
4. **Response Format:** Different response formats → All handled

### Admin Notification Tests
1. **Immediate Notification:** Admin notified as soon as supplier responds
2. **Content Accuracy:** Notification includes correct response content
3. **Context Information:** Notification includes original request context
4. **Multi-channel:** Notification sent via all configured channels

### Response Processing Tests
1. **Status Update:** Request status updated based on response
2. **Escalation Handling:** Escalation triggered when needed
3. **Archive Management:** Completed interactions properly archived
4. **Performance Tracking:** Response times and quality tracked

## Performance Considerations
- **Response Detection:** Should complete within 500ms
- **Admin Notification:** Should be sent within 1 second
- **Logging:** Should not impact response time significantly
- **Scalability:** Support multiple concurrent supplier interactions

## Error Handling
- **Detection Failure:** Fallback to manual review
- **Notification Failure:** Retry notification with exponential backoff
- **Logging Failure:** Continue processing with error logging
- **System Errors:** Graceful degradation with admin alerting

## Integration Points
- **Message Processing:** Integrate with message filtering system
- **Role Validation:** Check user permissions for supplier access
- **Admin System:** Integrate with admin notification system
- **Logging System:** Integrate with system logging
- **Monitoring:** Integrate with health monitoring system

## Security Considerations
- **Supplier Validation:** Verify supplier identity and permissions
- **Response Security:** Validate and sanitize supplier responses
- **Admin Access:** Secure admin notification delivery
- **Audit Logging:** Complete audit trail of all interactions
- **Data Protection:** Protect sensitive supplier information
