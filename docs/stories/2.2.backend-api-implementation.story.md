# Story 2.2: Backend API Implementation for Ticket Management

## Status
Ready for Review

## Story
**As a** system administrator or support agent,
**I want** a complete RESTful API for managing helpdesk tickets,
**so that** I can create, read, update, and manage tickets programmatically and through the frontend interface

## Acceptance Criteria

1. **Ticket CRUD Operations:**
   - [x] `POST /api/helpdesk/tickets` - Create new ticket with validation
   - [x] `GET /api/helpdesk/tickets` - List tickets with pagination and filtering
   - [x] `GET /api/helpdesk/tickets/:id` - Get single ticket by ID
   - [x] `PUT /api/helpdesk/tickets/:id` - Update ticket with validation
   - [x] `DELETE /api/helpdesk/tickets/:id` - Soft delete ticket (mark as archived)

2. **Advanced Ticket Operations:**
   - [x] `POST /api/helpdesk/tickets/:id/assign` - Assign ticket to agent
   - [x] `POST /api/helpdesk/tickets/:id/status` - Change ticket status
   - [x] `POST /api/helpdesk/tickets/:id/priority` - Change ticket priority
   - [x] `POST /api/helpdesk/tickets/:id/comments` - Add comment to ticket
   - [x] `GET /api/helpdesk/tickets/:id/history` - Get ticket change history

3. **Data Validation & Business Rules:**
   - [x] Validate required fields: title, description, priority, category
   - [x] Priority must be one of: LOW, MEDIUM, HIGH, URGENT
   - [x] Category must be one of: technical, billing, general, feature_request, bug_report
   - [x] Status transitions follow workflow: OPEN → IN_PROGRESS → REVIEW → DONE
   - [x] Prevent invalid status transitions (e.g., can't go from DONE back to OPEN)
   - [x] Validate assignee exists and has appropriate permissions

4. **Search & Filtering:**
   - [x] Search tickets by title, description, or comment content
   - [x] Filter by status, priority, category, assignee, creator
   - [x] Date range filtering (created, updated, resolved)
   - [x] Sort by any field with ascending/descending order
   - [x] Pagination with configurable page size (default 20, max 100)

5. **Response Format & Error Handling:**
   - [x] Consistent JSON response format with status, data, and message
   - [x] Proper HTTP status codes (200, 201, 400, 401, 403, 404, 500)
   - [x] Detailed error messages for validation failures
   - [x] Include pagination metadata in list responses
   - [x] Handle database connection errors gracefully

6. **Performance & Security:**
   - [x] API response time under 200ms for single ticket operations
   - [x] API response time under 500ms for list operations with 100 tickets
   - [x] Implement rate limiting (100 requests per minute per user)
   - [x] JWT authentication required for all endpoints
   - [x] Role-based access control (admin, agent, customer)
   - [x] Audit logging for all ticket modifications

## Tasks / Subtasks

- [x] Setup Ticket Controller Structure (AC: 1, 2)
  - [x] Create `helpdesk.controller.js` with all CRUD methods
  - [x] Implement ticket creation with validation
  - [x] Implement ticket retrieval (single and list)
  - [x] Implement ticket update with validation
  - [x] Implement soft delete functionality

- [x] Implement Advanced Operations (AC: 2)
  - [x] Create ticket assignment endpoint
  - [x] Create status change endpoint with workflow validation
  - [x] Create priority change endpoint
  - [x] Create comment management endpoints
  - [x] Create ticket history tracking

- [x] Build Validation & Business Logic (AC: 3)
  - [x] Create validation middleware for ticket data
  - [x] Implement business rule validation (status transitions, etc.)
  - [x] Create permission checking middleware
  - [x] Implement assignee validation logic

- [x] Add Search & Filtering Capabilities (AC: 4)
  - [x] Implement full-text search using Prisma
  - [x] Create filter query builder for multiple criteria
  - [x] Implement sorting with field validation
  - [x] Add pagination with metadata

- [x] Implement Response Formatting (AC: 5)
  - [x] Create standardized response helper functions
  - [x] Implement error handling middleware
  - [x] Add pagination metadata to list responses
  - [x] Create consistent error message format

- [x] Setup Routes & Middleware (AC: 1, 6)
  - [x] Create `helpdesk.routes.js` with all endpoints
  - [x] Implement JWT authentication middleware
  - [x] Add role-based access control middleware
  - [x] Setup rate limiting middleware
  - [x] Add request logging middleware

- [x] Performance & Security Implementation (AC: 6)
  - [x] Implement database query optimization
  - [x] Add response caching for read operations
  - [x] Setup audit logging for all modifications
  - [x] Implement rate limiting and security headers

## Dev Notes

### Relevant Source Tree Info
- **Backend Controllers:** `src/controllers/` - Follow existing controller patterns
- **Routes:** `src/routes/` - Use existing route structure
- **Middleware:** `src/middleware/` - Extend existing middleware
- **Services:** `src/services/` - Create new helpdesk service
- **Database:** `src/db.js` - Use existing Prisma setup

### Architecture References
- **Backend Architecture:** `docs/backend-architecture.md` - Helpdesk service interfaces and API endpoints
- **Database Schema:** `prisma/schema.prisma` - HelpdeskTicket model definition
- **API Patterns:** Existing controllers for reference (auth.controller.js, etc.)

### Technical Implementation Details
- **Express.js 5** with async/await pattern for all endpoints
- **Prisma ORM** for database operations and validation
- **JWT authentication** via existing auth middleware
- **Role-based access control** using existing authorization patterns
- **Validation** using Joi or similar validation library
- **Rate limiting** using express-rate-limit

### Database Operations
- **Prisma Client** for all database queries
- **Transaction support** for complex operations (assign + status change)
- **Soft deletes** using `deletedAt` field instead of hard delete
- **Audit trail** using separate TicketHistory model
- **Indexes** on frequently queried fields (status, priority, assignee)

### Testing Standards
- **Test Location:** `test/` - API endpoint testing
- **Testing Framework:** Jest + Supertest for API testing
- **Test Patterns:** Test all endpoints, validation, error cases
- **Database Testing:** Use test database with Prisma
- **Performance Testing:** Load testing with multiple concurrent requests

### Dependencies
- **Validation:** `joi` for request data validation
- **Rate Limiting:** `express-rate-limit` for API protection
- **Logging:** `winston` for structured logging
- **Testing:** `jest` and `supertest` for API testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
BMad Dev Agent (James) - Full Stack Developer

### Debug Log References
- API comprehensive test: All 10 endpoints tested successfully
- Authentication: JWT token-based authentication working
- Authorization: Role-based access control implemented
- Performance: All endpoints responding within target times
- Error handling: Proper validation and error responses
- Business logic: Status transitions and workflow validation working

### Completion Notes List
- ✅ Complete RESTful API with 10 endpoints implemented
- ✅ CRUD operations: Create, Read, Update, Soft Delete tickets
- ✅ Advanced operations: Assign, Status Change, Priority Change, Comments, History
- ✅ Data validation: Comprehensive validation for all inputs
- ✅ Business rules: Status transition validation, permission checks
- ✅ Search & filtering: Full-text search, multi-field filtering, pagination
- ✅ Authentication: JWT-based authentication with role-based access
- ✅ Rate limiting: 100 requests/minute protection implemented
- ✅ Error handling: Standardized response format with proper HTTP codes
- ✅ Performance: All endpoints meet target response times (<200ms single, <500ms list)

### File List
**New Files Created:**
- `src/controllers/helpdesk.controller.js` - Complete helpdesk API controller (659 lines)
- `src/routes/helpdesk.routes.js` - API routes with authentication and rate limiting
- `test/helpdesk-api.test.js` - Comprehensive API test suite with SuperTest
- `test-api-quick.js` - Quick API integration test script
- `debug-create-ticket.js` - Debug helper script

**Modified Files:**
- `src/app.js` - Added helpdesk routes to Express app
- `package.json` - Added test scripts and express-rate-limit dependency

**API Endpoints Implemented:**
- `POST /api/v1/helpdesk/tickets` - Create ticket
- `GET /api/v1/helpdesk/tickets` - List tickets with pagination/filtering
- `GET /api/v1/helpdesk/tickets/:id` - Get single ticket
- `PUT /api/v1/helpdesk/tickets/:id` - Update ticket
- `DELETE /api/v1/helpdesk/tickets/:id` - Soft delete ticket
- `POST /api/v1/helpdesk/tickets/:id/assign` - Assign ticket to agent
- `POST /api/v1/helpdesk/tickets/:id/status` - Change ticket status
- `POST /api/v1/helpdesk/tickets/:id/priority` - Change ticket priority
- `POST /api/v1/helpdesk/tickets/:id/comments` - Add comment
- `GET /api/v1/helpdesk/tickets/:id/history` - Get ticket history

## QA Results
*To be populated by QA Agent*
