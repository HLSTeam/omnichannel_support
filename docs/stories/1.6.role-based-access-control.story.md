# Story 1.6: Role-based Access Control

## Story Information
- **Epic:** Epic 1 - AI Core & Coordinator Bot
- **Story ID:** 1.6
- **Status:** To Do
- **Story Points:** 8
- **Priority:** High
- **Assignee:** TBD
- **Created:** 2025-08-21
- **Updated:** 2025-08-21

## User Story
**As a** system administrator  
**I want** phân quyền rõ ràng cho từng user role  
**So that** security được đảm bảo và quyền hạn được kiểm soát

## Acceptance Criteria

### A. Role Detection
- [ ] Automatically detect user role based on chat group
- [ ] Admin role: Users in groups with "admin" in title
- [ ] Supplier role: Users in groups with "supplier" in title
- [ ] User role: Default for all other users
- [ ] Private chat users default to "customer" role

### B. Permission Matrix
- [ ] **Admin permissions:**
  - [ ] Create notifications
  - [ ] Check system logs
  - [ ] Manage users
  - [ ] System control commands
  - [ ] Create helpdesk tickets
  - [ ] Check transaction status
  - [ ] **EXCLUDED:** RAG operations (knowledge base enrichment)

- [ ] **User permissions:**
  - [ ] Check transaction status only
  - [ ] Create helpdesk tickets
  - [ ] Check basic system status
  - [ ] **EXCLUDED:** Admin commands, system logs, notifications

- [ ] **Supplier permissions:**
  - [ ] Receive notifications from bot
  - [ ] Respond to bot requests
  - [ ] **EXCLUDED:** All command execution

### C. Authorization Enforcement
- [ ] Block unauthorized commands immediately
- [ ] Clear error message explaining permission denial
- [ ] Log all authorization attempts (success/failure)
- [ ] Audit trail for security monitoring

### D. Role Persistence
- [ ] Remember user role for session duration
- [ ] Update role if user moves between groups
- [ ] Handle role changes gracefully

## Technical Requirements

### Implementation Details
- **Role Detection:** Implement in n8n workflow based on chat group analysis
- **Permission Matrix:** Store in workflow context for validation
- **Authorization:** Check permissions before command execution
- **Audit Logging:** Log all authorization decisions

### Role Detection Logic
1. **Admin Role Detection:**
   - Check if chat title contains "admin" (case-insensitive)
   - Check if user is in admin-specific groups
   - Verify admin privileges

2. **Supplier Role Detection:**
   - Check if chat title contains "supplier" (case-insensitive)
   - Check if user is in supplier-specific groups
   - Verify supplier status

3. **User Role Detection:**
   - Default role for all other users
   - Private chat users get "customer" role
   - Basic permissions only

### Permission Validation
- **Command-level validation:** Check if command is allowed for user role
- **Parameter validation:** Check if parameters are within user permissions
- **Context validation:** Check if user can access specific resources

## Dependencies
- **Story 1.5:** Message filtering and tag processing
- **Story 1.2:** Intent analysis implementation
- **n8n workflow:** Existing coordinator bot workflow

## Definition of Done
- [ ] Role detection logic implemented in n8n workflow
- [ ] Permission matrix defined and implemented
- [ ] Authorization checks work for all commands
- [ ] Unauthorized access is properly blocked
- [ ] Audit logging captures all authorization decisions
- [ ] Role changes are handled gracefully
- [ ] Integration testing with existing workflow passes
- [ ] Security testing validates permission enforcement

## Dev Notes
- Implement role detection in n8n workflow
- Store role information in workflow context
- Use permission matrix for command validation
- Consider caching role information for performance
- Ensure secure role validation

## Security Considerations

### Access Control
- **Principle of least privilege:** Users get minimum required permissions
- **Role-based access:** Permissions tied to user roles
- **Command validation:** All commands validated against permissions
- **Audit logging:** Complete audit trail of all access attempts

### Data Protection
- **Role information:** Store securely in workflow context
- **Permission data:** Encrypt sensitive permission information
- **Audit logs:** Secure storage and access to audit logs
- **Session management:** Secure role persistence during sessions

## Testing Scenarios

### Role Detection Tests
1. **Admin role:** User in "Admin Support" group → Admin permissions
2. **Supplier role:** User in "Supplier Updates" group → Supplier permissions
3. **User role:** User in "Customer Support" group → Basic permissions
4. **Private chat:** Direct message to bot → Customer permissions

### Permission Tests
1. **Admin commands:** Admin tries to check logs → Allowed
2. **User commands:** User tries to check logs → Denied
3. **Supplier commands:** Supplier tries to create notification → Denied
4. **Cross-role access:** User tries admin command → Denied

### Authorization Tests
1. **Valid access:** User with permission executes command → Success
2. **Invalid access:** User without permission executes command → Denied
3. **Role change:** User moves between groups → Permissions updated
4. **Session persistence:** Role remembered during session → Consistent access

## Performance Considerations
- **Role detection:** Should complete within 200ms
- **Permission validation:** Should complete within 100ms
- **Caching:** Cache role information for session duration
- **Scalability:** Support multiple concurrent users with different roles

## Error Handling
- **Permission denied:** Clear explanation of why access was denied
- **Role detection failure:** Fallback to basic user permissions
- **Invalid role:** Log error and use default permissions
- **System errors:** Graceful degradation with security logging
