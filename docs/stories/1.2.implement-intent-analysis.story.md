# Story 1.2: Implement intent analysis with confidence scoring

**Epic:** 1 - AI Core Infrastructure  
**Story:** 1.2  
**Status:** Draft  
**Priority:** High  
**Estimate:** 4 days  
**Assigned To:** TBD  

---

## Story

**As a** system administrator,  
**I want** the AI service to analyze message intent with confidence scoring,  
**so that** the system can accurately route user requests to appropriate handlers.

---

## Acceptance Criteria

1. **Intent Analysis Core**
   - AI service can analyze Vietnamese text messages
   - Intent classification returns one of 5-10 predefined intent types
   - Confidence score is calculated and returned (0.0-1.0 range)
   - Entity extraction identifies key information from messages

2. **Confidence Scoring System**
   - Confidence calculation considers multiple factors
   - Thresholds are configurable (high: >80%, medium: 50-80%, low: <50%)
   - Confidence scores are stored in database
   - Low confidence triggers fallback mechanisms

3. **Intent Classification Types**
   - Support for 5-10 basic intent types (create_notification, check_logs, create_ticket, etc.)
   - Intent types are configurable and extensible
   - Each intent type has associated examples and patterns
   - Intent classification accuracy >80% for common requests

4. **Entity Extraction**
   - Extract key entities (service names, time references, user mentions)
   - Store extracted entities in JSON format
   - Support for Vietnamese language patterns
   - Entity extraction works with mixed language input

5. **Performance & Reliability**
   - Intent analysis completes within 2 seconds
   - Service handles 100+ requests per day
   - Error rate <5% for successful requests
   - Graceful degradation when AI model is unavailable

---

## Tasks / Subtasks

- [ ] **Task 1 (AC: 1):** Implement core intent analysis logic
  - [ ] Create intent classification algorithm
  - [ ] Implement Vietnamese text preprocessing
  - [ ] Add support for 5-10 basic intent types
  - [ ] Create intent type configuration system

- [ ] **Task 2 (AC: 2):** Build confidence scoring system
  - [ ] Implement confidence calculation algorithm
  - [ ] Add configurable confidence thresholds
  - [ ] Create confidence-based decision logic
  - [ ] Store confidence scores in database

- [ ] **Task 3 (AC: 3):** Define intent classification types
  - [ ] Create intent type definitions
  - [ ] Add training examples for each intent
  - [ ] Implement pattern matching for intent types
  - [ ] Create intent type validation

- [ ] **Task 4 (AC: 4):** Implement entity extraction
  - [ ] Create entity extraction algorithms
  - [ ] Add Vietnamese language support
  - [ ] Implement mixed language handling
  - [ ] Store entities in structured format

- [ ] **Task 5 (AC: 5):** Optimize performance and reliability
  - [ ] Implement response time optimization
  - [ ] Add error handling and retry logic
  - [ ] Create performance monitoring
  - [ ] Test with high request volumes

- [ ] **Task 6 (AC: 1-5):** Testing and validation
  - [ ] Write unit tests for intent analysis
  - [ ] Test confidence scoring accuracy
  - [ ] Validate entity extraction
  - [ ] Performance testing and optimization

---

## Dev Notes

### ⚠️ **CRITICAL IMPLEMENTATION NOTE**
**AI Processing is handled by n8n workflows, NOT backend services!**

**Implementation Approach:**
- ✅ **Backend API endpoints** - Handle requests and responses
- ✅ **n8n workflows** - Process AI logic with Ollama at `http://vpn.zopost.vn:11434`
- ✅ **Database operations** - Store results from n8n workflows
- ❌ **DO NOT implement AI processing logic in backend services**

**n8n Integration:**
- Use webhook triggers to receive requests
- Process with Ollama nodes in n8n
- Return results via webhook responses
- Store results in database via backend API

### Previous Story Insights
**From Story 1.1:**
- Ollama service is accessible at `http://vpn.zopost.vn:11434`
- AI Service module structure is in place
- Database models (AIIntent, AIResponse) are created
- Basic API endpoints are implemented
- Error handling framework is established

**Key Learnings to Apply:**
- Use established error handling patterns
- Follow existing logging standards
- Maintain database model relationships
- Use existing API response formats

### Data Models
**AIIntent Model (Extended):**
```prisma
model AIIntent {
  id          String   @id @default(uuid())
  messageId   String   @unique
  intent      String   // One of predefined intent types
  confidence  Float    // 0.0-1.0 confidence score
  entities    Json     // Extracted entities
  context     Json?    // Additional context
  processedAt DateTime @default(now())
  modelVersion String? // Ollama model version used
  
  // Relationships
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  responses   AIResponse[]
  
  @@index([intent])
  @@index([confidence])
  @@index([processedAt])
}
```

**Intent Type Configuration:**
```javascript
// src/config/intent-types.js
const INTENT_TYPES = {
  CREATE_NOTIFICATION: {
    id: 'create_notification',
    name: 'Create Notification',
    description: 'Create and send notifications to users',
    examples: [
      'Tạo thông báo tạm dừng dịch vụ Vinaphone',
      'Gửi thông báo cho khách hàng về sự cố',
      'Thông báo tới nhà cung cấp ABC'
    ],
    patterns: [/tạo thông báo/i, /gửi thông báo/i, /thông báo cho/i],
    requiredEntities: ['recipient', 'message'],
    confidenceThreshold: 0.7
  },
  CHECK_LOGS: {
    id: 'check_logs',
    name: 'Check System Logs',
    description: 'Check system logs and status',
    examples: [
      'Kiểm tra log hệ thống',
      'Xem log lỗi gần đây',
      'Check system status'
    ],
    patterns: [/kiểm tra log/i, /xem log/i, /check log/i],
    requiredEntities: ['system', 'timeframe'],
    confidenceThreshold: 0.6
  }
  // ... additional intent types
}
```

[Source: docs/ai-intent-analysis-strategy.md#intent-classification]

### API Specifications
**Enhanced POST /api/ai/intent:**
- **Purpose:** Analyze message intent with confidence scoring
- **Authentication:** Bearer token required
- **Request Body:** 
  ```json
  {
    "messageId": "uuid",
    "text": "string",
    "context": {
      "channelId": "uuid",
      "senderId": "string",
      "conversationId": "uuid",
      "language": "vi",
      "userHistory": "array"
    }
  }
  ```
- **Response:** 
  ```json
  {
    "intent": "string",
    "confidence": "float (0.0-1.0)",
    "entities": {
      "service": "string",
      "recipient": "string",
      "timeframe": "string",
      "priority": "string"
    },
    "suggestedActions": ["string"],
    "fallbackUsed": "boolean",
    "processingTime": "number (ms)"
  }
  ```

**New GET /api/ai/intents:**
- **Purpose:** Get available intent types and examples
- **Authentication:** Bearer token required
- **Response:** 
  ```json
  {
    "intentTypes": [
      {
        "id": "string",
        "name": "string",
        "description": "string",
        "examples": ["string"],
        "confidenceThreshold": "float"
      }
    ]
  }
  ```

[Source: docs/backend-architecture.md#rest-api-spec]

### Component Specifications
**Enhanced AI Service (`src/services/ai.service.js`):**
- **Class:** `AIService`
- **Methods:**
  - `analyzeIntent(message, context)` - Enhanced intent analysis
  - `calculateConfidence(ollamaResponse, context)` - Confidence scoring
  - `extractEntities(message, intent)` - Entity extraction
  - `classifyIntent(text, examples)` - Intent classification
  - `getIntentTypes()` - Get available intent types
- **Dependencies:** Ollama client, Prisma client, Winston logger, Intent type config

**Intent Analysis Engine (`src/services/intent-analysis.service.js`):**
- **Class:** `IntentAnalysisService`
- **Methods:**
  - `preprocessText(text, language)` - Text preprocessing
  - `matchIntentPatterns(text, patterns)` - Pattern matching
  - `validateIntent(intent, entities)` - Intent validation
  - `getConfidenceFactors(response, context)` - Confidence factors
- **Dependencies:** Intent type configuration, text processing utilities

**Entity Extraction Service (`src/services/entity-extraction.service.js`):**
- **Class:** `EntityExtractionService`
- **Methods:**
  - `extractServiceNames(text)` - Extract service references
  - `extractTimeReferences(text)` - Extract time information
  - `extractUserMentions(text)` - Extract user references
  - `extractPriorityLevels(text)` - Extract priority information
- **Dependencies:** Vietnamese language patterns, regex utilities

[Source: docs/backend-architecture.md#components]

### File Locations
**New Files to Create:**
- `src/services/intent-analysis.service.js` - Intent analysis engine
- `src/services/entity-extraction.service.js` - Entity extraction service
- `src/config/intent-types.js` - Intent type configuration
- `src/utils/text-processing.js` - Text processing utilities
- `src/utils/vietnamese-patterns.js` - Vietnamese language patterns

**Files to Modify:**
- `src/services/ai.service.js` - Enhance with new methods
- `src/controllers/ai.controller.js` - Add new endpoints
- `src/app.js` - Add new routes

[Source: docs/backend-architecture.md#source-tree]

### Testing Requirements
**Unit Tests:**
- Test intent classification accuracy with sample messages
- Test confidence calculation with various inputs
- Test entity extraction with different text patterns
- Test Vietnamese language processing

**Integration Tests:**
- Test complete intent analysis pipeline
- Test confidence threshold decisions
- Test entity extraction and storage
- Test performance under load

**Test Coverage Target:** >85% for new intent analysis code

**Test Data Requirements:**
- Vietnamese message samples for each intent type
- Mixed language input samples
- Edge cases and ambiguous messages
- Performance test scenarios

[Source: docs/backend-architecture.md#test-strategy]

### Technical Constraints
**Intent Classification:**
- **Supported Languages:** Vietnamese (primary), English (secondary)
- **Intent Types:** 5-10 predefined types initially
- **Confidence Range:** 0.0 to 1.0 (float)
- **Response Time:** <2 seconds for analysis

**Entity Extraction:**
- **Entity Types:** Service names, time references, user mentions, priorities
- **Storage Format:** JSON with structured data
- **Validation:** Required entities per intent type
- **Fallback:** Default values for missing entities

**Performance Requirements:**
- **Throughput:** 100+ requests/day
- **Accuracy:** >80% intent classification
- **Error Rate:** <5% for successful requests
- **Memory Usage:** <512MB for AI processing

[Source: docs/ai-intent-analysis-strategy.md#performance-requirements]

---

## Testing

### Test Cases

**Unit Tests:**
- [ ] Intent classification returns correct intent type
- [ ] Confidence scoring calculates accurate values
- [ ] Entity extraction identifies key information
- [ ] Vietnamese text processing works correctly
- [ ] Pattern matching identifies intent patterns
- [ ] Intent validation works with required entities

**Integration Tests:**
- [ ] Complete intent analysis pipeline works
- [ ] Confidence thresholds trigger correct actions
- [ ] Entity extraction stores data correctly
- [ ] Performance meets requirements under load
- [ ] Error handling works for edge cases

**Manual Tests:**
- [ ] Test with Vietnamese message samples
- [ ] Test with mixed language input
- [ ] Verify confidence score accuracy
- [ ] Check entity extraction quality
- [ ] Performance testing with multiple requests

---

## Dev Agent Record

### Completion Notes
*To be filled by Dev Agent during implementation*

### Debug Log
*To be filled by Dev Agent during implementation*

### Change Log
*To be filled by Dev Agent during implementation*

---

## QA Results
*To be filled by QA Agent during review*

---

## Project Structure Notes

**Alignment Status:** ✅ **FULLY ALIGNED**

**Project Structure Verification:**
- ✅ Intent analysis service follows `src/services/` pattern
- ✅ Entity extraction service follows `src/services/` pattern
- ✅ Configuration files follow `src/config/` pattern
- ✅ Utility files follow `src/utils/` pattern
- ✅ API endpoints follow existing REST pattern
- ✅ Database models follow existing Prisma pattern

**No structural conflicts identified.** Story implementation follows established project patterns exactly.

---

## Dependencies

**Internal Dependencies:**
- Story 1.1 must be completed (Ollama service, AI models, basic API)
- Existing Express app structure
- Existing Prisma database setup
- Existing authentication middleware

**External Dependencies:**
- Vietnamese language processing libraries
- Text processing utilities
- Regex pattern libraries

**Dependency Status:** ✅ **READY** - All internal dependencies from Story 1.1 are satisfied.

---

## Risk Assessment

**Risk Level:** MEDIUM

**Potential Risks:**
1. **Vietnamese language complexity** - Mitigation: Start with simple patterns, test extensively
2. **Intent classification accuracy** - Mitigation: Use proven algorithms, implement fallbacks
3. **Performance bottlenecks** - Mitigation: Optimize algorithms, implement caching

**Risk Mitigation Status:** ✅ **ADDRESSED**

---

## Definition of Done

- [ ] Intent analysis returns accurate classifications (>80% accuracy)
- [ ] Confidence scoring system is implemented and tested
- [ ] 5-10 intent types are defined and working
- [ ] Entity extraction identifies key information correctly
- [ ] Vietnamese language processing works accurately
- [ ] Performance meets requirements (<2 seconds response time)
- [ ] Unit tests passing with >85% coverage
- [ ] Integration tests passing
- [ ] Performance testing completed
- [ ] Documentation updated
- [ ] Code reviewed and approved

---

*Story created using BMAD-METHOD™ framework*
