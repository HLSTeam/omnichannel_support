# Story 1.7: Transaction Status API Integration

## Story Information
- **Epic:** Epic 1 - AI Core & Coordinator Bot
- **Story ID:** 1.7
- **Status:** To Do
- **Story Points:** 8
- **Priority:** Medium
- **Assignee:** TBD
- **Created:** 2025-08-21
- **Updated:** 2025-08-21

## User Story
**As a** regular user  
**I want** kiểm tra trạng thái giao dịch qua API  
**So that** biết được giao dịch thành công hay thất bại

## Acceptance Criteria

### A. API Integration
- [ ] Connect to external transaction system API
- [ ] Support multiple transaction ID formats
- [ ] Handle API authentication securely
- [ ] Implement request timeout (30 seconds)
- [ ] Retry mechanism for transient failures

### B. Transaction Status Response
- [ ] Return clear status: "success", "failed", "pending", "cancelled"
- [ ] Include transaction details: ID, amount, timestamp, description
- [ ] Handle unknown transaction IDs gracefully
- [ ] Format response for Telegram display

### C. Error Handling
- [ ] Handle API unavailability gracefully
- [ ] Clear error messages for users
- [ ] Log API failures for monitoring
- [ ] Fallback response when API is down

### D. Performance & Caching
- [ ] Cache transaction results for 5 minutes
- [ ] Avoid repeated API calls for same transaction
- [ ] Response time under 10 seconds for cached results
- [ ] Response time under 30 seconds for new API calls

## Technical Requirements

### Implementation Details
- **API Integration:** Implement as n8n HTTP Request node
- **Authentication:** Secure API credentials management
- **Caching:** Implement caching in workflow context
- **Error Handling:** Graceful degradation for API failures

### API Specifications
1. **Endpoint:** External transaction system API
2. **Authentication:** API key or OAuth2 token
3. **Request Format:** GET /transaction/{id}
4. **Response Format:** JSON with transaction details
5. **Timeout:** 30 seconds maximum

### Transaction Status Values
- **success:** Transaction completed successfully
- **failed:** Transaction failed or rejected
- **pending:** Transaction in progress
- **cancelled:** Transaction was cancelled
- **unknown:** Transaction ID not found

### Caching Strategy
- **Cache Duration:** 5 minutes
- **Cache Key:** Transaction ID + timestamp
- **Cache Invalidation:** Time-based expiration
- **Cache Storage:** Workflow context variables

## Dependencies
- **Story 1.5:** Message filtering and tag processing
- **Story 1.6:** Role-based access control
- **External API:** Transaction system API access
- **n8n workflow:** Existing coordinator bot workflow

## Definition of Done
- [ ] API integration implemented in n8n workflow
- [ ] Transaction status checking works for valid IDs
- [ ] Error handling works for API failures
- [ ] Caching system implemented and working
- [ ] Response formatting optimized for Telegram
- [ ] Performance benchmarks met
- [ ] Integration testing with external API passes
- [ ] Documentation updated with API details

## Dev Notes
- Implement as n8n HTTP Request node
- Use external API credentials securely
- Implement caching in workflow context
- Consider rate limiting for API calls
- Monitor API response times

## API Integration Details

### Request Configuration
```json
{
  "method": "GET",
  "url": "{{$json.apiEndpoint}}/transaction/{{$json.transactionId}}",
  "headers": {
    "Authorization": "Bearer {{$json.apiToken}}",
    "Content-Type": "application/json"
  },
  "timeout": 30000
}
```

### Response Processing
1. **Parse API Response:** Extract transaction details
2. **Status Mapping:** Map API status to internal status
3. **Data Validation:** Validate required fields
4. **Format Response:** Format for Telegram display

### Error Scenarios
- **API Unavailable:** Return cached result or fallback message
- **Invalid Transaction ID:** Clear error message with format guidance
- **Authentication Failed:** Log error and return user-friendly message
- **Timeout:** Return timeout message and suggest retry

## Security Considerations

### API Security
- **Authentication:** Secure API key management
- **Rate Limiting:** Prevent API abuse
- **Data Validation:** Validate all API responses
- **Error Logging:** Log security-related errors

### Data Protection
- **Transaction IDs:** Validate format before API calls
- **Response Data:** Sanitize before display
- **Cache Security:** Secure cache storage
- **Audit Logging:** Log all API interactions

## Testing Scenarios

### API Integration Tests
1. **Valid Transaction:** Check status of existing transaction → Success
2. **Invalid Transaction:** Check status of non-existent ID → Error handled
3. **API Down:** External API unavailable → Fallback response
4. **Timeout:** API response too slow → Timeout handling

### Caching Tests
1. **First Request:** New transaction ID → API call, cache result
2. **Cached Request:** Same transaction ID within 5 minutes → Cached result
3. **Expired Cache:** Same transaction ID after 5 minutes → New API call
4. **Cache Invalidation:** Force cache refresh → New API call

### Performance Tests
1. **Cached Response:** Response time < 10 seconds
2. **New API Call:** Response time < 30 seconds
3. **Concurrent Requests:** Handle multiple simultaneous requests
4. **High Volume:** Support high transaction check volumes

## Performance Considerations
- **Response Time:** Cached results under 10 seconds
- **API Calls:** New requests under 30 seconds
- **Caching:** 5-minute cache duration for performance
- **Concurrency:** Support multiple concurrent users

## Error Handling

### User-Friendly Messages
- **Transaction Not Found:** "Transaction ID ABC123 không tồn tại. Vui lòng kiểm tra lại."
- **API Unavailable:** "Hệ thống đang bảo trì. Vui lòng thử lại sau."
- **Invalid Format:** "Định dạng ID giao dịch không đúng. Vui lòng sử dụng format: ABC123"
- **Timeout:** "Yêu cầu quá thời gian. Vui lòng thử lại."

### Logging & Monitoring
- **API Failures:** Log all API errors with details
- **Performance Metrics:** Track response times
- **Cache Hit Rate:** Monitor caching effectiveness
- **Error Rates:** Track error frequency and types

## Integration Points
- **Message Processing:** Integrate with message filtering system
- **Role Validation:** Check user permissions for transaction access
- **Response Formatting:** Format responses for Telegram display
- **Logging System:** Integrate with system logging
- **Monitoring:** Integrate with health monitoring system
