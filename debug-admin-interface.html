<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Interface Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .api-test { background: #e8f4fd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .result { background: #f9f9f9; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üîß Admin Interface Debug Page</h1>
    
    <div class="debug">
        <h3>üìä Current State:</h3>
        <div id="currentState">Loading...</div>
    </div>
    
    <div class="debug">
        <h3>üîê Authentication Test:</h3>
        <button onclick="testAuth()">Test Authentication</button>
        <button onclick="testTelegramGroupsAPI()">Test Telegram Groups API</button>
        <button onclick="clearStorage()">Clear Storage</button>
    </div>
    
    <div class="api-test">
        <h3>üß™ API Test Results:</h3>
        <div id="apiResults">No tests run yet...</div>
    </div>
    
    <div class="debug">
        <h3>üìù Logs:</h3>
        <div id="logs"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function updateCurrentState() {
            const state = document.getElementById('currentState');
            const authToken = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            const agentProfile = localStorage.getItem('agentProfile');
            
            let html = `
                <strong>Auth Token:</strong> ${authToken ? '‚úÖ Present' : '‚ùå Missing'}<br>
                <strong>User:</strong> ${user ? '‚úÖ Present' : '‚ùå Missing'}<br>
                <strong>Agent Profile:</strong> ${agentProfile ? '‚úÖ Present' : '‚ùå Missing'}<br>
            `;
            
            if (authToken) {
                html += `<strong>Token Length:</strong> ${authToken.length} characters<br>`;
                html += `<strong>Token Preview:</strong> ${authToken.substring(0, 20)}...<br>`;
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    html += `<strong>User Role:</strong> ${userData.role || 'N/A'}<br>`;
                    html += `<strong>User Name:</strong> ${userData.name || 'N/A'}<br>`;
                } catch (e) {
                    html += `<strong>User Role:</strong> <span class="error">Parse Error</span><br>`;
                }
            }
            
            if (agentProfile) {
                try {
                    const agentData = JSON.parse(agentProfile);
                    html += `<strong>Agent Role:</strong> ${agentData.role || 'N/A'}<br>`;
                    html += `<strong>Agent Name:</strong> ${agentData.name || 'N/A'}<br>`;
                } catch (e) {
                    html += `<strong>Agent Role:</strong> <span class="error">Parse Error</span><br>`;
                }
            }
            
            state.innerHTML = html;
        }

        async function testAuth() {
            log('üß™ Testing authentication...');
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                log('‚ùå No auth token found', 'error');
                return;
            }
            
            log(`‚úÖ Auth token found: ${authToken.substring(0, 20)}...`);
            
            // Test if token is valid by calling a protected endpoint
            try {
                const response = await fetch('http://localhost:3000/api/v1/telegram-groups', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ API call successful! Found ${data.data?.length || 0} groups`, 'success');
                    
                    // Display the results
                    const results = document.getElementById('apiResults');
                    results.innerHTML = `
                        <h4>‚úÖ API Response:</h4>
                        <div class="result">
                            <strong>Status:</strong> ${response.status}<br>
                            <strong>Groups Count:</strong> ${data.data?.length || 0}<br>
                            <strong>Response:</strong><br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    const errorData = await response.text();
                    log(`‚ùå API call failed: ${response.status} - ${errorData}`, 'error');
                    
                    const results = document.getElementById('apiResults');
                    results.innerHTML = `
                        <h4>‚ùå API Error:</h4>
                        <div class="result">
                            <strong>Status:</strong> ${response.status}<br>
                            <strong>Error:</strong> ${errorData}
                        </div>
                    `;
                }
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`, 'error');
                
                const results = document.getElementById('apiResults');
                results.innerHTML = `
                    <h4>‚ùå Network Error:</h4>
                    <div class="result">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function testTelegramGroupsAPI() {
            log('üß™ Testing Telegram Groups API directly...');
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                log('‚ùå No auth token found', 'error');
                return;
            }
            
            try {
                // Test the exact endpoint that the component calls
                const response = await fetch('http://localhost:3000/api/v1/telegram-groups', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const results = document.getElementById('apiResults');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Direct API call successful!`, 'success');
                    
                    results.innerHTML = `
                        <h4>‚úÖ Direct API Test:</h4>
                        <div class="result">
                            <strong>Status:</strong> ${response.status}<br>
                            <strong>Groups Found:</strong> ${data.data?.length || 0}<br>
                            <strong>First Group:</strong><br>
                            <pre>${data.data?.[0] ? JSON.stringify(data.data[0], null, 2) : 'No groups'}</pre>
                        </div>
                    `;
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Direct API call failed: ${response.status}`, 'error');
                    
                    results.innerHTML = `
                        <h4>‚ùå Direct API Test Failed:</h4>
                        <div class="result">
                            <strong>Status:</strong> ${response.status}<br>
                            <strong>Error:</strong> ${errorText}
                        </div>
                    `;
                }
            } catch (error) {
                log(`‚ùå Direct API test error: ${error.message}`, 'error');
                
                const results = document.getElementById('apiResults');
                results.innerHTML = `
                    <h4>‚ùå Direct API Test Error:</h4>
                    <div class="result">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function clearStorage() {
            localStorage.clear();
            log('‚úÖ Storage cleared', 'success');
            updateCurrentState();
            
            const results = document.getElementById('apiResults');
            results.innerHTML = 'Storage cleared. Please login again to test.';
        }

        // Auto-update state every second
        setInterval(updateCurrentState, 1000);
        
        // Initial state
        updateCurrentState();
        log('üöÄ Admin Interface Debug Page loaded');
        log('üí° Use this page to debug authentication and API issues');
    </script>
</body>
</html>
